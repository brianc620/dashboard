<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Dashboard</title>
<style>
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

  /* â”€â”€ Theme: Default â”€â”€ */
  :root, [data-theme="default"]{
    --bg:       #0b0d14;
    --surface:  #13151e;
    --border:   #1e2230;
    --border-hi:#2a2f42;
    --text:     #e4e6ef;
    --text-dim: #6b7194;
    --accent:   #6c72ff;
    --green:    #22c55e;
    --red:      #ef4444;
    --radius:   1rem;
    --font:     'Segoe UI',system-ui,-apple-system,sans-serif;
    --card-blur:0px;
    --body-bg-image:none;
  }

  /* â”€â”€ Theme: Clean Light â”€â”€ */
  [data-theme="light"]{
    --bg:       #f5f5f7;
    --surface:  #ffffff;
    --border:   #e2e2e6;
    --border-hi:#ccccd0;
    --text:     #1d1d1f;
    --text-dim: #86868b;
    --accent:   #0071e3;
    --green:    #1a8a3f;
    --red:      #d12e2e;
    --radius:   1rem;
    --font:     'Segoe UI',system-ui,sans-serif;
    --card-blur:0px;
    --body-bg-image:none;
  }

  body{
    min-height:100vh;
    background:var(--bg);
    background-image:var(--body-bg-image);
    color:var(--text);
    font-family:var(--font);
    padding:1.5rem;
    line-height:1.5;
    transition:background .4s,color .3s;
  }

  /* â”€â”€ header â”€â”€ */
  header{
    text-align:center;margin-bottom:2rem;
  }
  header h1{
    font-size:clamp(1.4rem,3.5vw,2rem);font-weight:700;
    letter-spacing:-.02em;
    margin-bottom:.25rem;
  }
  header h1 span{
    background:linear-gradient(135deg,var(--accent),#00b4ff);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .updated{font-size:.8rem;color:var(--text-dim)}

  /* â”€â”€ theme picker â”€â”€ */
  .theme-bar{
    display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;
    margin-top:.7rem;
  }
  .theme-btn{
    border:2px solid var(--border);
    border-radius:.5rem;
    padding:.3rem .7rem;
    font-size:.68rem;font-weight:600;
    letter-spacing:.04em;
    cursor:pointer;
    background:var(--surface);
    color:var(--text-dim);
    transition:border-color .2s,color .2s,transform .15s;
  }
  .theme-btn:hover{border-color:var(--accent);color:var(--text);transform:scale(1.04)}
  .theme-btn.active{border-color:var(--accent);color:var(--accent)}

  /* â”€â”€ grid â”€â”€ */
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:1.25rem;
    max-width:1000px;
    margin:0 auto;
  }
  @media(max-width:700px){.grid{grid-template-columns:1fr}}

  /* â”€â”€ card â”€â”€ */
  .card{
    background:var(--surface);
    backdrop-filter:blur(var(--card-blur));
    -webkit-backdrop-filter:blur(var(--card-blur));
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1.4rem;
    transition:background .4s,border-color .25s,box-shadow .25s,border-radius .3s;
  }
  .card:hover{
    border-color:var(--border-hi);
    box-shadow:0 4px 24px rgba(0,0,0,.35);
  }
  .card.span{grid-column:1/-1}

  .card-label{
    font-size:.7rem;font-weight:600;
    text-transform:uppercase;letter-spacing:.12em;
    color:var(--text-dim);margin-bottom:.9rem;
    display:flex;align-items:center;gap:.45rem;
  }
  .card-label .icon{font-size:.95rem}

  /* â”€â”€ weather â”€â”€ */
  .weather-main{display:flex;align-items:center;gap:1rem;margin-bottom:.7rem}
  .weather-icon{font-size:2.6rem;line-height:1}
  .weather-temp{font-size:2.4rem;font-weight:700;letter-spacing:-.03em}
  .weather-desc{font-size:.9rem;color:var(--text-dim);margin-bottom:.7rem}
  .weather-details{display:flex;gap:1.4rem;font-size:.82rem;color:var(--text-dim)}
  .weather-details span{display:flex;align-items:center;gap:.3rem}

  /* â”€â”€ gallery showcase â”€â”€ */
  .gallery-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.2rem}
  @media(max-width:700px){.gallery-grid{grid-template-columns:1fr}}
  .gallery-item{
    background:rgba(255,255,255,.02);
    border:1px solid var(--border);
    border-radius:.7rem;
    overflow:hidden;
    transition:border-color .25s,transform .25s;
  }
  .gallery-item:hover{border-color:var(--border-hi);transform:translateY(-3px)}
  .gallery-item img{
    width:100%;aspect-ratio:4/3;object-fit:cover;display:block;
    opacity:0;transition:opacity .5s;
  }
  .gallery-item img.loaded{opacity:1}
  .gallery-item .info{padding:.8rem}
  .gallery-item .g-title{font-size:.92rem;font-weight:600;margin-bottom:.2rem}
  .gallery-item .g-artist{font-size:.78rem;color:var(--text-dim);margin-bottom:.15rem}
  .gallery-item .g-meta{font-size:.68rem;color:var(--text-dim);margin-bottom:.5rem}
  .gallery-item .g-link{
    display:inline-block;font-size:.7rem;font-weight:600;
    color:var(--accent);text-decoration:none;
    transition:opacity .2s;
  }
  .gallery-item .g-link:hover{opacity:.75}
  .gallery-refresh{
    display:flex;justify-content:center;margin-top:.9rem;
  }
  .gallery-refresh button{
    background:rgba(108,114,255,.12);
    border:1px solid rgba(108,114,255,.25);
    color:var(--accent);
    font-size:.78rem;font-weight:600;
    padding:.4rem .9rem;
    border-radius:.5rem;
    cursor:pointer;
    transition:background .2s,transform .15s;
  }
  .gallery-refresh button:hover{background:rgba(108,114,255,.22);transform:scale(1.03)}

  /* â”€â”€ stocks â”€â”€ */
  .stock-price{font-size:1.7rem;font-weight:700;margin-bottom:.8rem;letter-spacing:-.02em}
  .stock-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem}
  .stock-cell{text-align:center}
  .stock-cell .period{font-size:.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.2rem}
  .stock-cell .ret{font-size:.95rem;font-weight:700;border-radius:.4rem;padding:.25rem .1rem}
  .stock-cell .ret.up{color:var(--green);background:rgba(34,197,94,.08)}
  .stock-cell .ret.down{color:var(--red);background:rgba(239,68,68,.08)}
  .stock-cell .ret.flat{color:var(--text-dim)}

  /* â”€â”€ loading / error states â”€â”€ */
  .skeleton{
    background:linear-gradient(90deg,#1a1c28 25%,#222430 50%,#1a1c28 75%);
    background-size:200% 100%;
    animation:shimmer 1.5s infinite;
    border-radius:.35rem;
    height:1em;
    width:60%;
  }
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .error-msg{color:var(--red);font-size:.82rem}

  /* â”€â”€ mini bar chart (sparkline) â”€â”€ */
  .spark{display:flex;gap:2px;margin-top:.3rem}
  .spark-col{display:flex;flex-direction:column;align-items:center;flex:1;min-width:0}
  .spark-pct{font-size:.5rem;font-weight:600;white-space:nowrap;margin-bottom:2px;line-height:1}
  .spark-pct.up{color:var(--green)}.spark-pct.down{color:var(--red)}.spark-pct.flat{color:var(--text-dim)}
  .spark-area{height:44px;position:relative;width:100%}
  .spark-area::after{
    content:'';position:absolute;left:0;right:0;top:50%;
    border-top:1px solid rgba(255,255,255,.1);pointer-events:none;
  }
  .spark-area .bar{position:absolute;left:0;right:0;transition:height .3s}
  .spark-date{font-size:.45rem;color:var(--text-dim);white-space:nowrap;margin-top:2px;line-height:1}

  /* â”€â”€ snow report â”€â”€ */
  .snow-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media(max-width:500px){.snow-grid{grid-template-columns:1fr}}
  .snow-section-label{
    font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;
    color:var(--text-dim);margin-bottom:.5rem;
  }
  .snow-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.4rem}
  .snow-stat{
    text-align:center;padding:.55rem .3rem;
    background:rgba(255,255,255,.03);border-radius:.5rem;
    border:1px solid rgba(255,255,255,.04);
  }
  .snow-stat .val{font-size:1.3rem;font-weight:700;line-height:1.1}
  .snow-stat .val.has-snow{color:#7dd3fc}
  .snow-stat .lbl{font-size:.58rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.06em;margin-top:.2rem}
  .snow-meta{
    margin-top:.8rem;font-size:.72rem;color:var(--text-dim);
    display:flex;flex-wrap:wrap;gap:.3rem 1.2rem;
  }
  .snow-meta strong{color:var(--text);font-weight:600}

  /* â”€â”€ news â”€â”€ */
  .news-list{list-style:none;display:flex;flex-direction:column;gap:.55rem}
  .news-item a{
    color:var(--text);
    text-decoration:none;
    font-size:.85rem;
    line-height:1.35;
    display:block;
    padding:.5rem .65rem;
    border-radius:.5rem;
    background:rgba(255,255,255,.02);
    border:1px solid transparent;
    transition:background .2s,border-color .2s;
  }
  .news-item a:hover{
    background:rgba(255,255,255,.05);
    border-color:var(--border-hi);
  }
  .news-source{
    font-size:.62rem;font-weight:600;
    text-transform:uppercase;letter-spacing:.06em;
    color:var(--text-dim);margin-top:.2rem;
  }
  .news-time{color:var(--accent);font-size:.62rem;margin-left:.5rem;letter-spacing:0}
</style>
</head>
<body>

<header>
  <h1><span>Dashboard</span></h1>
  <div class="updated">Last updated: <span id="last-updated">loading...</span> &middot; Auto-refreshes</div>
  <div class="theme-bar" id="theme-bar">
    <button class="theme-btn active" data-theme="default">Dark</button>
    <button class="theme-btn" data-theme="light">Light</button>
  </div>
</header>

<div class="grid">

  <!-- Weather: Boulder -->
  <div class="card" id="weather-boulder">
    <div class="card-label"><span class="icon">&#9729;</span> Boulder, CO</div>
    <div id="wb-content"><div class="skeleton" style="width:80%;height:2.4rem;margin-bottom:.6rem"></div><div class="skeleton" style="width:50%"></div></div>
  </div>

  <!-- Weather: Vail -->
  <div class="card" id="weather-vail">
    <div class="card-label"><span class="icon">&#9968;</span> Vail, CO</div>
    <div id="wv-content"><div class="skeleton" style="width:80%;height:2.4rem;margin-bottom:.6rem"></div><div class="skeleton" style="width:50%"></div></div>
  </div>

  <!-- Snow: Vail -->
  <div class="card span" id="snow-vail">
    <div class="card-label"><span class="icon">&#10052;</span> Vail Snow Report</div>
    <div id="snow-content"><div class="skeleton" style="width:80%;margin-bottom:.6rem"></div><div class="skeleton" style="width:60%"></div></div>
  </div>

  <!-- Stock: SPY -->
  <div class="card" id="stock-spy">
    <div class="card-label"><span class="icon">&#9650;</span> SPY &mdash; S&amp;P 500 ETF</div>
    <div id="spy-content"><div class="skeleton" style="width:40%;height:1.7rem;margin-bottom:.8rem"></div><div class="skeleton" style="width:100%"></div></div>
  </div>

  <!-- Stock: IGV -->
  <div class="card" id="stock-igv">
    <div class="card-label"><span class="icon">&#9650;</span> IGV &mdash; Software ETF</div>
    <div id="igv-content"><div class="skeleton" style="width:40%;height:1.7rem;margin-bottom:.8rem"></div><div class="skeleton" style="width:100%"></div></div>
  </div>

  <!-- Delta: IGV vs SPY -->
  <div class="card span" id="stock-delta">
    <div class="card-label"><span class="icon">&#9878;</span> IGV vs SPY &mdash; Relative Performance</div>
    <div id="delta-content"><div class="skeleton" style="width:100%"></div></div>
  </div>

  <!-- News: Top Stories -->
  <div class="card" id="news-general">
    <div class="card-label"><span class="icon">&#9783;</span> Top Stories</div>
    <div id="news-general-content"><div class="skeleton" style="width:90%;margin-bottom:.6rem"></div><div class="skeleton" style="width:75%;margin-bottom:.6rem"></div><div class="skeleton" style="width:85%"></div></div>
  </div>

  <!-- News: NBA -->
  <div class="card" id="news-nba">
    <div class="card-label"><span class="icon">&#9917;</span> NBA News</div>
    <div id="news-nba-content"><div class="skeleton" style="width:90%;margin-bottom:.6rem"></div><div class="skeleton" style="width:75%;margin-bottom:.6rem"></div><div class="skeleton" style="width:85%"></div></div>
  </div>

  <!-- SmithKlein Gallery -->
  <div class="card span" id="gallery-card">
    <div class="card-label"><span class="icon">&#9734;</span> SmithKlein Gallery Showcase</div>
    <div id="gallery-content">
      <div class="gallery-grid">
        <div class="gallery-item"><div class="skeleton" style="width:100%;aspect-ratio:4/3"></div><div class="info"><div class="skeleton" style="width:70%;margin-bottom:.4rem"></div><div class="skeleton" style="width:50%"></div></div></div>
        <div class="gallery-item"><div class="skeleton" style="width:100%;aspect-ratio:4/3"></div><div class="info"><div class="skeleton" style="width:70%;margin-bottom:.4rem"></div><div class="skeleton" style="width:50%"></div></div></div>
        <div class="gallery-item"><div class="skeleton" style="width:100%;aspect-ratio:4/3"></div><div class="info"><div class="skeleton" style="width:70%;margin-bottom:.4rem"></div><div class="skeleton" style="width:50%"></div></div></div>
      </div>
    </div>
  </div>

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WEATHER_INTERVAL = 10 * 60_000;   // 10 min
const GALLERY_INTERVAL     = 5  * 60_000;   // 5 min
const STOCK_INTERVAL   = 15 * 60_000;   // 15 min (no key limits now)
const NEWS_INTERVAL    = 15 * 60_000;   // 15 min

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEATHER  (Open-Meteo, no key needed)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WMO = {
  0:['Clear','â˜€ï¸'],1:['Mostly Clear','ğŸŒ¤ï¸'],2:['Partly Cloudy','â›…'],3:['Overcast','â˜ï¸'],
  45:['Fog','ğŸŒ«ï¸'],48:['Rime Fog','ğŸŒ«ï¸'],
  51:['Light Drizzle','ğŸŒ§ï¸'],53:['Drizzle','ğŸŒ§ï¸'],55:['Heavy Drizzle','ğŸŒ§ï¸'],
  56:['Freezing Drizzle','ğŸŒ§ï¸'],57:['Heavy Freezing Drizzle','ğŸŒ§ï¸'],
  61:['Light Rain','ğŸŒ§ï¸'],63:['Rain','ğŸŒ§ï¸'],65:['Heavy Rain','ğŸŒ§ï¸'],
  66:['Freezing Rain','ğŸŒ§ï¸'],67:['Heavy Freezing Rain','ğŸŒ§ï¸'],
  71:['Light Snow','ğŸŒ¨ï¸'],73:['Snow','ğŸŒ¨ï¸'],75:['Heavy Snow','â„ï¸'],
  77:['Snow Grains','â„ï¸'],
  80:['Light Showers','ğŸŒ¦ï¸'],81:['Showers','ğŸŒ¦ï¸'],82:['Heavy Showers','ğŸŒ¦ï¸'],
  85:['Snow Showers','ğŸŒ¨ï¸'],86:['Heavy Snow Showers','ğŸŒ¨ï¸'],
  95:['Thunderstorm','â›ˆï¸'],96:['Thunderstorm + Hail','â›ˆï¸'],99:['Severe Thunderstorm','â›ˆï¸'],
};

const LOCATIONS = [
  {name:'Boulder, CO', lat:40.015,  lon:-105.2705, elId:'wb-content'},
  {name:'Vail, CO',    lat:39.6403, lon:-106.3742, elId:'wv-content'},
];

async function fetchWeather(){
  for(const loc of LOCATIONS){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}`
        + `&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,apparent_temperature`
        + `&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FDenver`;
      const res = await fetch(url);
      const data = await res.json();
      const c = data.current;
      const [desc, icon] = WMO[c.weather_code] || ['Unknown','ğŸŒ¡ï¸'];
      document.getElementById(loc.elId).innerHTML = `
        <div class="weather-main">
          <div class="weather-icon">${icon}</div>
          <div class="weather-temp">${Math.round(c.temperature_2m)}Â°F</div>
        </div>
        <div class="weather-desc">${desc}</div>
        <div class="weather-details">
          <span>Feels ${Math.round(c.apparent_temperature)}Â°</span>
          <span>ğŸ’§ ${c.relative_humidity_2m}%</span>
          <span>ğŸ’¨ ${Math.round(c.wind_speed_10m)} mph</span>
        </div>`;
    }catch(e){
      document.getElementById(loc.elId).innerHTML = `<div class="error-msg">Weather unavailable â€” ${e.message}</div>`;
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VAIL SNOW REPORT  (vail.com + Open-Meteo forecast)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchVailSnow(){
  const el = document.getElementById('snow-content');
  try{
    // â”€â”€ 1. Past snowfall from vail.com (official ski patrol data) â”€â”€
    let vailData = null;
    const vailUrl = 'https://www.vail.com/the-mountain/mountain-conditions/snow-and-weather-report.aspx';
    const proxyUrls = [
      `https://corsproxy.io/?url=${encodeURIComponent(vailUrl)}`,
      `https://api.allorigins.win/raw?url=${encodeURIComponent(vailUrl)}`,
    ];
    for(const url of proxyUrls){
      try{
        const res = await fetch(url);
        if(!res.ok) continue;
        const html = await res.text();
        const match = html.match(/FR\.snowReportData\s*=\s*(\{[\s\S]*?\});/);
        if(match){ vailData = JSON.parse(match[1]); break; }
      }catch{ continue; }
    }

    // â”€â”€ 2. Forecast snowfall from Open-Meteo â”€â”€
    const meteoUrl = 'https://api.open-meteo.com/v1/forecast'
      + '?latitude=39.6403&longitude=-106.3742&hourly=snowfall'
      + '&forecast_days=7&timezone=America%2FDenver';
    const meteoRes = await fetch(meteoUrl);
    const meteoData = await meteoRes.json();

    // sum forecast snowfall (cm) for next 24h, 48h, 7d from current hour
    const hours = meteoData.hourly.time;
    const snowCm = meteoData.hourly.snowfall;
    const now = new Date();
    // find first hour >= now
    let startIdx = 0;
    for(let i = 0; i < hours.length; i++){
      if(new Date(hours[i]) >= now){ startIdx = i; break; }
    }
    function sumHours(from, count){
      let total = 0;
      for(let i = from; i < Math.min(from + count, snowCm.length); i++){
        total += (snowCm[i] || 0);
      }
      return total / 2.54; // cm â†’ inches
    }
    const next24 = sumHours(startIdx, 24);
    const next48 = sumHours(startIdx, 48);
    const next7d = sumHours(startIdx, 168);

    // â”€â”€ 3. Build display â”€â”€
    // past data from vail.com (falls back to "â€”" if scrape failed)
    const past24  = vailData ? vailData.TwentyFourHourSnowfall.Inches : 'â€”';
    const past48  = vailData ? vailData.FortyEightHourSnowfall.Inches : 'â€”';
    const past7d  = vailData ? vailData.SevenDaySnowfall.Inches : 'â€”';
    const base    = vailData ? vailData.BaseDepth.Inches : 'â€”';
    const season  = vailData ? vailData.CurrentSeason.Inches : 'â€”';
    const updated = vailData ? vailData.LastUpdatedText : '';

    function snowVal(v, unit){
      const n = typeof v === 'number' ? v.toFixed(1) : v;
      const hasSnow = (typeof v === 'number' ? v > 0.05 : (parseInt(v) > 0));
      return `<div class="val${hasSnow ? ' has-snow' : ''}">${n}${unit || '"'}</div>`;
    }

    el.innerHTML = `
      <div class="snow-grid">
        <div>
          <div class="snow-section-label">Past (actual)</div>
          <div class="snow-stats">
            <div class="snow-stat">${snowVal(past7d)}<div class="lbl">7 day</div></div>
            <div class="snow-stat">${snowVal(past48)}<div class="lbl">48 hr</div></div>
            <div class="snow-stat">${snowVal(past24)}<div class="lbl">24 hr</div></div>
          </div>
        </div>
        <div>
          <div class="snow-section-label">Forecast</div>
          <div class="snow-stats">
            <div class="snow-stat">${snowVal(next24)}<div class="lbl">24 hr</div></div>
            <div class="snow-stat">${snowVal(next48)}<div class="lbl">48 hr</div></div>
            <div class="snow-stat">${snowVal(next7d)}<div class="lbl">7 day</div></div>
          </div>
        </div>
      </div>
      <div class="snow-meta">
        <span>Base depth: <strong>${base}"</strong></span>
        <span>Season total: <strong>${season}"</strong></span>
        ${updated ? `<span>Past data via vail.com &middot; ${updated}</span>` : '<span>Past data via vail.com</span>'}
        <span>Forecast via Open-Meteo</span>
      </div>`;
  }catch(e){
    el.innerHTML = `<div class="error-msg">Snow report unavailable â€” ${e.message}</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GALLERY  (SmithKlein â€” paintings data embedded)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const galleryData = [{"artist":"Lyudmila Agrich","artist_url":"https://smithklein.com/artist/lyudmila-agrich","paintings":[{"title":"Koi Swirl","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/ws8bbmc1fs650vqwugkh.jpg","page_url":"https://smithklein.com/art/koi-swirl-by-lyudmila-agrich"},{"title":"Rainy Day in Paris","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/sdk8m72z8a7zcc1373gs.jpg","page_url":"https://smithklein.com/art/rainy-day-in-paris-by-lyudmila-agrich-ii"},{"title":"Brooklyn Bridge in the Fall","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/ct79fircqckbon0q9hlo.jpg","page_url":"https://smithklein.com/art/brooklyn-bridge-in-the-fall-by-lyudmila-agrich"},{"title":"View of Montmarte","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/tsz55tdmn6b45q4gr6nm.jpg","page_url":"https://smithklein.com/art/view-of-montmarte-by-lyudmila-agrich"},{"title":"Premier Night","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/9vyyvffarh9qia9gnuyq.jpg","page_url":"https://smithklein.com/art/premier-night-by-lyudmila-agrich"},{"title":"Rainy Walk","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/hqk6pn35fltgjvuf0eri.jpg","page_url":"https://smithklein.com/art/rainy-walk-by-lyudmila-agrich-i"},{"title":"Rainy Day in Paris","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/12tjros692z27tl81h0x.jpg","page_url":"https://smithklein.com/art/rainy-day-in-paris-by-lyudmila-agrich-i"},{"title":"In Romantic Mood","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/v0d123rjovwvu3u4g2oj.jpg","page_url":"https://smithklein.com/art/in-romantic-mood-by-lyudmila-agrich"},{"title":"Magnificent World of Waterlilies","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/i9jqfzwuww4h8f6knrl7.jpg","page_url":"https://smithklein.com/art/magnificent-world-of-waterlilies-by-lyudmila-agrich"},{"title":"Fall in Brooklyn Heights","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/5p3zg6ej0n8bgts8705w.jpg","page_url":"https://smithklein.com/art/fall-in-brooklyn-heights-by-lyudmila-agrich"},{"title":"Magic Colors of Colorado","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/nfowwo81f0c4bqihxlod.jpg","page_url":"https://smithklein.com/art/magic-colors-of-colorado-by-lyudmila-agrich"},{"title":"Autumn in Montmartre","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/uswd0xe1ortwwuskg1np.jpg","page_url":"https://smithklein.com/art/autumn-in-montmartre-by-lyudmila-agrich"},{"title":"Wild Poppies","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/3pf5vg149rsb4m2nskbc.jpg","page_url":"https://smithklein.com/art/wild-poppies-by-lyudmila-agrich"},{"title":"Parisian Umbrellas","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/8yak3eicpt3yxnn4zszk.jpg","page_url":"https://smithklein.com/art/parisian-umbrellas-by-lyudmila-agrich"},{"title":"Remembering Paris","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/aci8m52xmlsjvowi0rpm.jpg","page_url":"https://smithklein.com/art/remembering-paris-by-lyudmila-agrich"},{"title":"Rainy Day in Old Town","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/1g8y0dpeiryq8x3s1eoo.jpg","page_url":"https://smithklein.com/art/rainy-day-in-old-town-by-lyudmila-agrich"},{"title":"Evening Ride","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/cc3elodmw4rp65u66ax6.jpg","page_url":"https://smithklein.com/art/evening-ride-by-lyudmila-agrich"},{"title":"Night Walk on Broadway","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/d1poyy94dylrmsx396uo.jpg","page_url":"https://smithklein.com/art/night-walk-on-broadway-by-lyudmila-agrich"},{"title":"Evening Descends on Paris","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/pcyinyy4nuxkxqi28j2r.jpg","page_url":"https://smithklein.com/art/evening-descends-on-paris-by-lyudmila-agrich"},{"title":"Rainy Afternoon in Chicago","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/ekuvcn5gssgoqsd7gj9l.jpg","page_url":"https://smithklein.com/art/rainy-afternoon-in-chicago-by-lyudmila-agrich"},{"title":"Spring","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/nmfscds4cyhe2e187q13.png","page_url":"https://smithklein.com/art/spring-by-lyudmila-agrich-ii"},{"title":"Venetian Song","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/aj42kg90225lynbj1hrz.jpg","page_url":"https://smithklein.com/art/venetian-song-by-lyudmila-agrich"},{"title":"Parisian Cafe","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/p3fg2fiq4tfvhsyg9gpn.jpg","page_url":"https://smithklein.com/art/parisian-cafe-by-lyudmila-agrich"},{"title":"Ocean Surf","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/d7pmeko3013rexm025p8.jpg","page_url":"https://smithklein.com/art/ocean-surf-by-lyudmila-agrich-i"},{"title":"Urban Jungle","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/e2zk7v80w1bktglny2ol.jpg","page_url":"https://smithklein.com/art/urban-jungle-by-lyudmila-agrich"},{"title":"Memories of Paris","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/fqugpv0f0i3a2q29e2i3.jpg","page_url":"https://smithklein.com/art/memories-of-paris-by-lyudmila-agrich"},{"title":"City Sketch","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/qly1srr9rq8zk9jexdwu.jpg","page_url":"https://smithklein.com/art/city-sketch-by-lyudmila-agrich-i"}]},{"artist":"Sergey Cherep","artist_url":"https://smithklein.com/artist/sergey-cherep","paintings":[{"title":"Aspens Colorado 2","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/tuzqcykc6iva3tajx0qt.jpg","page_url":"https://smithklein.com/art/aspens-colorado-2-by-sergey-cherep"},{"title":"Colorado Mountains 1","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/6e7cwnr1dq0kg6i9ogin.jpg","page_url":"https://smithklein.com/art/colorado-mountains-1-by-sergey-cherep"},{"title":"Colorado Dream","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/qq3013o68uegy4ntq3yt.jpg","page_url":"https://smithklein.com/art/colorado-dream-by-sergey-cherep"},{"title":"Aspens Colorado","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/9cnbxyafebxjjccj3qq8.jpg","page_url":"https://smithklein.com/art/aspens-colorado-by-sergey-cherep"},{"title":"Marroon Mountain, CO","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/60ihgqw4x58nlmm05f12.jpg","page_url":"https://smithklein.com/art/marroon-mountain-co-by-sergey-cherep"},{"title":"Siesta Key FL","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/hw35h3dxiufxsdqimzl9.jpg","page_url":"https://smithklein.com/art/siesta-key-fl-by-sergey-cherep"},{"title":"Chicago Skyline","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/pmoy2i88gq6qi8fpot7x.jpg","page_url":"https://smithklein.com/art/chicago-skyline-by-sergey-cherep"},{"title":"Aspens","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/fv5ss2364f2kufurn57y.jpg","page_url":"https://smithklein.com/art/aspens-by-sergey-cherep-iv"}]},{"artist":"Dmitri Danish","artist_url":"https://smithklein.com/artist/dmitri-danish","paintings":[{"title":"Evening in Small Town","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/g9hl5k6v7u01yxx4fpnu.jpg","page_url":"https://smithklein.com/art/evening-in-small-town-by-dmitri-danish"},{"title":"Rainy Street","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/a8n5r6wi5qeb7ui76c1n.jpg","page_url":"https://smithklein.com/art/rainy-street-by-dmitri-danish"},{"title":"Terrachina Midday","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/s64eege3w7n2khoh32xd.jpg","page_url":"https://smithklein.com/art/terrachina-midday-by-dmitri-danish"},{"title":"Lisbon Motive","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/9ejml8qu1mq99gkqxnt5.jpg","page_url":"https://smithklein.com/art/lisbon-motive-by-dmitri-danish"}]},{"artist":"Yury Darash","artist_url":"https://smithklein.com/artist/yury-darash","paintings":[{"title":"Behind the Scenes #9","medium":"Acrylic, Wood, Resin and Metal","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/pfvqr2n47exp9smya2op.png","page_url":"https://smithklein.com/art/behind-the-scenes-9-by-yury-darash"},{"title":"Behind the Scenes #2","medium":"Acrylic, Wood, Resin and Metal","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/cls1k9ee6o43jqi4wayi.jpg","page_url":"https://smithklein.com/art/behind-the-scenes-2-by-yury-darash"},{"title":"Orange Sunset","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/d8pgesuvdrun4i9xwmet.jpg","page_url":"https://smithklein.com/art/orange-sunset-by-yury-darash"},{"title":"Warming Up","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/xafpu5064c3hp4itt4lb.jpg","page_url":"https://smithklein.com/art/warming-up-by-yury-darash"},{"title":"It Is Coming","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/gijnelapxuxlrv2b6nyd.jpg","page_url":"https://smithklein.com/art/it-is-coming-by-yury-darash"},{"title":"Wondering Light","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/12hqnhncackdoixs97e5.jpg","page_url":"https://smithklein.com/art/wondering-light-by-yury-darash"},{"title":"Changing Colors","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/1bcpxf1silsblyqg0960.jpg","page_url":"https://smithklein.com/art/changing-colors-by-yury-darash"},{"title":"Bright Path","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/z22wzrjg7l825rx2uzkc.jpg","page_url":"https://smithklein.com/art/bright-path-by-yury-darash"},{"title":"Challenge","medium":"Acrylic and Oil on Panel","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/56s6l1jy1atifmags94o.jpg","page_url":"https://smithklein.com/art/challenge-by-yury-darash"},{"title":"One on One","medium":"Acrylic and Oil","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/xwx3q5b826yyufhy524w.jpg","page_url":"https://smithklein.com/art/one-on-one-by-yury-darash"}]},{"artist":"Craig Mooney","artist_url":"https://smithklein.com/artist/craig-mooney","paintings":[{"title":"Summit Light","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/bsqngk9yirqbxyx7tzec.jpg","page_url":"https://smithklein.com/art/summit-light-by-craig-mooney"},{"title":"Radiant Sky","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/me1s0t0v10v5lz140xzi.jpg","page_url":"https://smithklein.com/art/radiant-sky-by-craig-mooney"},{"title":"Quietude","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/jwya1no2m1fu7kb7mmqk.jpg","page_url":"https://smithklein.com/art/quietude-by-craig-mooney"},{"title":"Sea Light","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/9ocklyouz9lf495ljh6g.jpg","page_url":"https://smithklein.com/art/sea-light-by-craig-mooney"},{"title":"Rising Fog","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/o4bg0foiwcr6mx31bl5z.jpg","page_url":"https://smithklein.com/art/rising-fog-by-craig-mooney"},{"title":"Northern Light","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/12k0y8nxexgaxmnzzibh.jpg","page_url":"https://smithklein.com/art/northern-light-by-craig-mooney"},{"title":"Blue Green Wave","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/9ve6sduh8mtr7cai3snj.jpg","page_url":"https://smithklein.com/art/green-wave-by-craig-mooney"},{"title":"Luminous Tide","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/pw85543rcg4g0z79cqaq.jpg","page_url":"https://smithklein.com/art/luminous-tide-by-craig-mooney"},{"title":"Another Glimpse","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/w1s9vzp6okeh9r79aotv.jpg","page_url":"https://smithklein.com/art/another-glimps-by-craig-mooney"},{"title":"Point Light","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/510oe472vlboxpqsjfop.jpg","page_url":"https://smithklein.com/art/point-light-by-craig-mooney"},{"title":"Drifting Shadows","medium":"Oil on Canvas","dimensions":"","image_url":"https://cdn.artcld.com/img/w_1920,c_fit/owptn4paqcee88p8y1yt.jpg","page_url":"https://smithklein.com/art/drifting-shadows-by-craig-mooney"}]}];

function fetchGallery(){
  const el = document.getElementById('gallery-content');
  try{
    // flatten all paintings, attach artist name, filter out show/gallery pages
    const all = [];
    for(const artist of galleryData){
      for(const p of artist.paintings){
        if(!p.medium || p.title.toUpperCase().includes('SMITHKLEIN GALLERY')) continue;
        all.push({...p, artist: artist.artist, artist_url: artist.artist_url});
      }
    }

    // pick 3 random, non-repeating
    const shuffled = all.sort(() => Math.random() - 0.5);
    const picks = shuffled.slice(0, 3);

    el.innerHTML = `
      <div class="gallery-grid">
        ${picks.map(p => `
          <div class="gallery-item">
            <img src="${p.image_url}" alt="${p.title}" onload="this.classList.add('loaded')">
            <div class="info">
              <div class="g-title">${p.title}</div>
              <div class="g-artist">${p.artist}</div>
              <div class="g-meta">${p.medium}${p.dimensions ? ' Â· ' + p.dimensions : ''}</div>
              <a class="g-link" href="${p.page_url}" target="_blank" rel="noopener">View on SmithKlein &rarr;</a>
            </div>
          </div>
        `).join('')}
      </div>
      <div class="gallery-refresh">
        <button onclick="fetchGallery()">&#8635; Show different paintings</button>
      </div>`;
  }catch(e){
    el.innerHTML = `<div class="error-msg">Gallery unavailable â€” ${e.message}</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOCKS  (Yahoo Finance â€” no API key needed)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ALL_PERIODS = ['1D','3D','5D','1M','YTD','1Y'];

// store returns per symbol so we can compute deltas
const storedReturns = {};

function calcReturn(currentPrice, prevPrice){
  if(prevPrice == null) return null;
  return ((currentPrice - prevPrice) / prevPrice) * 100;
}

function returnCell(label, ret){
  if(ret == null){
    return `<div class="stock-cell"><div class="period">${label}</div><div class="ret flat">â€”</div></div>`;
  }
  const cls  = ret > 0.01 ? 'up' : ret < -0.01 ? 'down' : 'flat';
  const sign = ret > 0 ? '+' : '';
  return `<div class="stock-cell"><div class="period">${label}</div><div class="ret ${cls}">${sign}${ret.toFixed(2)}%</div></div>`;
}

async function fetchChart(symbol){
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=1y&interval=1d`;
  // try direct first, then CORS proxies as fallback
  const urls = [
    yahooUrl,
    `https://corsproxy.io/?url=${encodeURIComponent(yahooUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`,
  ];
  for(const url of urls){
    try{
      const res = await fetch(url);
      if(!res.ok) continue;
      const json = await res.json();
      if(json.chart?.result?.[0]) return json.chart.result[0];
    }catch{ continue; }
  }
  throw new Error('All data sources failed');
}

async function fetchStock(symbol, elId){
  const el = document.getElementById(elId);
  try{
    const result = await fetchChart(symbol);
    const timestamps = result.timestamp;
    const rawCloses  = result.indicators.adjclose?.[0]?.adjclose
                    || result.indicators.quote[0].close;
    const displayPrice = result.meta.regularMarketPrice;

    // filter out null closes, pair with timestamps
    const data = [];
    for(let i = 0; i < timestamps.length; i++){
      if(rawCloses[i] != null) data.push({ts: timestamps[i], close: rawCloses[i]});
    }
    const n = data.length;
    if(!n){ el.innerHTML = `<div class="error-msg">No price data returned</div>`; return; }

    const price = data[n-1].close;

    // compute returns for each period
    const rets = {};
    rets['1D'] = n > 1  ? calcReturn(price, data[n-1-1].close)  : null;
    rets['3D'] = n > 3  ? calcReturn(price, data[n-1-3].close)  : null;
    rets['5D'] = n > 5  ? calcReturn(price, data[n-1-5].close)  : null;
    rets['1M'] = n > 21 ? calcReturn(price, data[n-1-21].close) : null;

    // YTD: last close of previous year
    const prevYear = new Date().getFullYear() - 1;
    let ytdClose = null;
    for(let i = n - 1; i >= 0; i--){
      if(new Date(data[i].ts * 1000).getFullYear() === prevYear){ ytdClose = data[i].close; break; }
    }
    rets['YTD'] = calcReturn(price, ytdClose);

    // 1Y: first data point in the range
    rets['1Y'] = calcReturn(price, data[0].close);

    // store for delta
    storedReturns[symbol] = rets;

    // build return cells
    let cells = '';
    for(const label of ALL_PERIODS) cells += returnCell(label, rets[label]);

    // mini sparkline from last 20 trading days â€” diverging bar chart
    const recent = data.slice(-20);
    const closes = recent.map(d => d.close);
    const dailyRets = closes.map((c,i) => i === 0 ? 0 : ((c - closes[i-1]) / closes[i-1]) * 100);
    const maxAbs = Math.max(...dailyRets.map(r => Math.abs(r)), 0.1);
    let bars = '';
    for(let i = 0; i < closes.length; i++){
      const pct = dailyRets[i];
      const cls = pct > 0.01 ? 'up' : pct < -0.01 ? 'down' : 'flat';
      const sign = pct > 0 ? '+' : '';
      const pctLabel = i === 0 ? 'â€”' : `${sign}${pct.toFixed(1)}`;
      const h = (Math.abs(pct) / maxAbs) * 20;
      let barStyle;
      if(pct >= 0){
        barStyle = `bottom:50%;height:${h}px;background:var(--green);border-radius:2px 2px 0 0;`;
      } else {
        barStyle = `top:50%;height:${h}px;background:var(--red);border-radius:0 0 2px 2px;`;
      }
      const daysBack = closes.length - 1 - i;
      const dateLabel = daysBack === 0 ? 'T' : `T-${daysBack}`;
      bars += `<div class="spark-col"><div class="spark-pct ${i===0?'flat':cls}">${pctLabel}</div><div class="spark-area"><div class="bar" style="${barStyle}"></div></div><div class="spark-date">${dateLabel}</div></div>`;
    }

    el.innerHTML = `
      <div class="stock-price">$${(displayPrice || price).toFixed(2)}</div>
      <div class="stock-grid">${cells}</div>
      <div style="margin-top:.7rem;font-size:.65rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em">Daily change â€” last 20 trading days</div>
      <div class="spark">${bars}</div>`;
  }catch(e){
    el.innerHTML = `<div class="error-msg">Stock data unavailable â€” ${e.message}</div>`;
  }
}

function renderDelta(){
  const el = document.getElementById('delta-content');
  const spy = storedReturns['SPY'];
  const igv = storedReturns['IGV'];
  if(!spy || !igv){
    el.innerHTML = `<div class="error-msg">Waiting for stock data...</div>`;
    return;
  }
  let cells = '';
  for(const label of ALL_PERIODS){
    const s = spy[label], g = igv[label];
    const delta = (s != null && g != null) ? g - s : null;
    cells += returnCell(label, delta);
  }
  el.innerHTML = `
    <div style="font-size:.78rem;color:var(--text-dim);margin-bottom:.6rem">Positive = IGV outperforming SPY</div>
    <div class="stock-grid">${cells}</div>`;
}

async function fetchStocks(){
  await fetchStock('SPY','spy-content');
  await fetchStock('IGV','igv-content');
  renderDelta();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEWS  (via rss2json.com â€” ESPN NBA + BBC Top Stories)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const NEWS_FEEDS = [
  {
    label: 'Top Stories',
    elId:  'news-general-content',
    rss:   'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
    count: 6,
  },
  {
    label: 'NBA',
    elId:  'news-nba-content',
    rss:   'https://www.espn.com/espn/rss/nba/news',
    count: 6,
  },
];

function timeAgo(dateStr){
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if(mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if(hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

async function fetchNews(){
  for(const feed of NEWS_FEEDS){
    const el = document.getElementById(feed.elId);
    try{
      const url = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.rss)}`;
      const res = await fetch(url);
      const data = await res.json();
      if(data.status !== 'ok' || !data.items?.length){
        el.innerHTML = `<div class="error-msg">No headlines available</div>`;
        continue;
      }
      const items = data.items.slice(0, feed.count);
      el.innerHTML = `<ul class="news-list">${items.map(item => {
        const source = item.author || new URL(item.link).hostname.replace('www.','');
        return `<li class="news-item"><a href="${item.link}" target="_blank" rel="noopener">
          ${item.title}
          <div class="news-source">${source}<span class="news-time">${timeAgo(item.pubDate)}</span></div>
        </a></li>`;
      }).join('')}</ul>`;
    }catch(e){
      el.innerHTML = `<div class="error-msg">News unavailable â€” ${e.message}</div>`;
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT & AUTO-REFRESH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateTimestamp(){
  document.getElementById('last-updated').textContent =
    new Date().toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
}

const SNOW_INTERVAL = 30 * 60_000;   // 30 min

async function init(){
  updateTimestamp();
  fetchWeather();
  fetchVailSnow();
  fetchGallery();
  fetchStocks();
  fetchNews();
}

init();
setInterval(()=>{ fetchWeather();  updateTimestamp(); }, WEATHER_INTERVAL);
setInterval(()=>{ fetchVailSnow(); updateTimestamp(); }, SNOW_INTERVAL);
setInterval(()=>{ fetchGallery();      updateTimestamp(); }, GALLERY_INTERVAL);
setInterval(()=>{ fetchStocks();   updateTimestamp(); }, STOCK_INTERVAL);
setInterval(()=>{ fetchNews();     updateTimestamp(); }, NEWS_INTERVAL);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME SWITCHER  (persists via localStorage)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function initThemes(){
  const saved = localStorage.getItem('dashboard-theme') || 'default';
  document.documentElement.setAttribute('data-theme', saved);

  document.getElementById('theme-bar').addEventListener('click', e => {
    const btn = e.target.closest('.theme-btn');
    if(!btn) return;
    const theme = btn.dataset.theme;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('dashboard-theme', theme);
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });

  // mark the saved theme button as active on load
  const activeBtn = document.querySelector(`.theme-btn[data-theme="${saved}"]`);
  if(activeBtn){
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    activeBtn.classList.add('active');
  }
})();
</script>
</body>
</html>
